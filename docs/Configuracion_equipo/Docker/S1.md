# S1 – Servidor NGINX como proxy inverso y balanceador de carga

## Objetivo de S1
Configuramos el servidor S1 con NGINX dentro de Docker para que reciba todas las peticiones HTTP de los clientes y actúe como proxy inverso, repartiendo la carga entre los contenedores S2 y S3 que ejecutan extagram.php.
​
Además, definir las rutas necesarias para redirigir correctamente el tráfico hacia la parte dinámica (S2–S3 y S4) y la parte estática (S5 y S6), dejando preparada la arquitectura de alta disponibilidad descrita en el enunciado del proyecto.

S1 envía la primera petición a S2, la segunda a S3, y así sucesivamente de forma cíclica. Esto justifica por qué tenemos dos servidores en el bloque upstream.

## Configuración y Funcionamiento de S1
- **Despliegue del Contenedor:** Comando base para ejecutar el contenedor S1. Se utiliza el volumen en modo read-only (:ro) para asegurar que el contenedor no modifique accidentalmente la configuración maestra
  ```sql
  docker run -d \
    --name s1-s1-nginx-1 \
    --network red_extagram \
    -p 80:80 \
    -v ~/sprint2/S1/conf/extagram.conf:/etc/nginx/conf.d/default.conf:ro \
    nginx:latest
  ```
- **Estructura del contenedor:**
  ```sql
  S1/
  ├── docker-compose.yml   
  ├── extagram.php         
  └── s1-nginx/            
      ├── Dockerfile       
      └── extagram.conf    
  ```
  | Fichero | Función Técnica |
  |--------|------|
  | docker-compose.yml | Orquestrador: Define la red interna, los volúmenes compartidos y el orden de arranque de todos los contenedores (S1-S7). |
  | extagram.php | Interfaz de Usuario: Archivo principal que contiene el formulario de carga y la lógica para mostrar el feed de publicaciones desde la base de datos. |
  | s1-nginx/Dockerfile | Configurador de Imagen: Construye el servidor Nginx personalizado con las rutas de balanceo de carga. |
  | s1-nginx/extagram.conf | Motor de Rutas: Define que /storage/ va a S5, /static/ va a S6, y los ficheros .php se reparten entre S2 y S3. |

- **Contenido de ficheros:**
  - **docker-compose.yml**:
    ```sql
     services:
      # S1: Balanceador de Carga y Proxy Inverso
      s1-nginx:
        build: ./s1-nginx
        image: s1-nginx
        container_name: s1-s1-nginx-1
        ports:
          - "80:80"
        networks:
          - red_entrada # Expuesto al exterior
        depends_on:
          - s2-phpfpm
          - s3-phpfpm
          - s4-upload
    
      # S2: Nodo de Aplicación 1 (Procesamiento Dinámico)
      s2-phpfpm:
        image: php:8.2-fpm-alpine
        container_name: s1-s2-phpfpm-1
        networks:
          - red_entrada      # Comunicación con el Proxy S1
          - red_servicios    # Comunicación interna
          - red_datos        # Comunicación con la BD S7
        volumes:
          - /home/ec2-user/sprint2/S2/src:/var/www/extagram:rw # Código fuente
        depends_on:
          - s7-mysql
    
      # S3: Nodo de Aplicación 2 (Alta Disponibilidad)
      s3-phpfpm:
        image: php:8.2-fpm-alpine
        container_name: s1-s3-phpfpm-1
        networks:
          - red_entrada
          - red_servicios
          - red_datos
        volumes:
          - /home/ec2-user/sprint2/S3/src:/var/www/extagram:rw # Nodo redundante
        depends_on:
          - s7-mysql
    
      # S4: Microservicio de Carga de Archivos
      s4-upload:
        image: php:8.2-fpm-alpine
        container_name: s1-s4-upload-1
        networks:
          - red_entrada
          - red_servicios
          - red_datos
        volumes:
          - /home/ec2-user/sprint2/S4/src:/var/www/extagram:rw
          # Volum compartido con S5 para persistencia de imágenes
          - /home/ec2-user/sprint2/S5/storage:/var/www/extagram/uploads:rw
        depends_on:
          - s7-mysql
    
      # S6: Servidor de Activos Estáticos (CSS, Logos, Iconos)
      s1-s6-static-1:
        image: nginx:alpine
        container_name: s1-s1-s6-static-1-1
        networks:
          - red_entrada
          - red_servicios
        volumes:
          - /home/ec2-user/sprint2/S6/static:/usr/share/nginx/html:ro
    
      # S5: Servidor de Almacenamiento (Fotos de usuarios)
      s1-s5-storage-1:
        image: nginx:alpine
        container_name: s1-s1-s5-storage-1-1
        networks:
          - red_entrada
          - red_servicios
        volumes:
          # Montado en modo solo lectura (RO) para seguridad
          - /home/ec2-user/sprint2/S5/storage:/usr/share/nginx/html:ro
    
      # S7: Base de Datos Centralizada
      s7-mysql:
        image: mysql:8.0
        container_name: s7-mysql
        restart: always
        environment:
          MYSQL_DATABASE: extagram_db
          MYSQL_USER: extagram_admin
          MYSQL_PASSWORD: pass123
          MYSQL_ROOT_PASSWORD: rootpass
        networks:
          - red_datos # Aislada del exterior
        volumes:
          - db_data:/var/lib/mysql # Persistencia de datos
          - /home/ec2-user/sprint2/S7/init/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    
    # Definición de redes para segregación de tráfico
    networks:
      red_entrada:   # Tráfico desde el cliente
        driver: bridge
      red_servicios: # Tráfico entre microservicios
        driver: bridge
      red_datos:     # Tráfico exclusivo de base de datos
        driver: bridge
    
    volumes:
      db_data: # Volumen nombrado para MySQL
  
  - **extagram.php**:
    ```sql
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Extagram</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>
    <body>
    <header class="main-header"><h1>extagram</h1></header>
    <main class="main-container">
        <form method="POST" enctype="multipart/form-data" action="upload.php">
            <input type="text" name="post" placeholder="Escribe algo..." required>
            
            <input id="file" type="file" name="photo" accept="image/*" style="display: none;" 
                   onchange="document.getElementById('preview').src=window.URL.createObjectURL(this.files[0])">
            
            <label for="file" style="cursor: pointer; display: block; text-align: center; border: 2px dashed #ccc; padding: 20px;">
                <img id="preview" src="/static/preview.svg" alt="Preview" style="width:100px; margin-bottom: 10px;">
                <br><span>Seleccionar foto</span>
            </label>
            
            <input type="submit" value="Publish" class="publish-btn">
        </form>
    
        <div class="feed">
            <?php
            // Conexión al servicio S7 usando el nombre del contenedor como Host
            $db = new mysqli("s7-mysql", "extagram_admin", "pass123", "extagram_db");
            
            if (!$db->connect_error) {
                // Consulta de publicaciones en orden cronológico inverso
                $resultado = $db->query("SELECT * FROM posts ORDER BY id DESC");
                
                while ($fila = $resultado->fetch_assoc()) {
                    echo "<article class='post' style='border: 1px solid #444; margin: 10px; padding: 10px; background: #1a1a1a; border-radius: 8px;'>";
                    
                    // Si existe un nombre de archivo, la imagen se pide a S5 vía /storage/
                    if (!empty($fila['filename'])) {
                        $url_imagen = "/storage/" . htmlspecialchars($fila['filename']);
                        echo "<img src='" . $url_imagen . "' style='width:100%; max-width:400px;'>";
                    }
                    
                    echo "<p style='color: white;'><strong>" . htmlspecialchars($fila['post']) . "</strong></p>";
                    echo "</article>";
                }
                $db->close();
            }
            ?>
        </div>
    </main>
    </body>
    </html>
    ```
  - **Dockerfile**:
    ```sql
    # Paso 1: Usamos la imagen oficial de Nginx basada en Alpine por su ligereza y seguridad
    FROM nginx:alpine
    
    # Paso 2: Copiamos nuestro archivo de configuración personalizado (extagram.conf)
    # Este archivo sobreescribe la configuración por defecto para implementar el balanceo de carga
    COPY extagram.conf /etc/nginx/conf.d/default.conf
    
    # Paso 3: Exponemos el puerto 80, que es el puerto estándar para tráfico HTTP
    # Este puerto se mapeará en el docker-compose.yml al puerto 80 del Host (EC2)
    EXPOSE 80
    
    # Nota: Nginx se inicia automáticamente gracias al ENTRYPOINT de la imagen base
    ```
  - **extagram.conf**:
    ```sql
    # Definición de Upstream para Balanceo de Carga entre S2 y S3
    upstream php_app {
        server s1-s2-phpfpm-1:9000;
        server s1-s3-phpfpm-1:9000;
        keepalive 32; # Mantiene conexiones abiertas para mejorar rendimiento
    }
    
    server {
        listen 80;
        server_name _;
        root /var/www/extagram;
    
        # REGLA 1: Web Principal (Balanceo de carga S2/S3)
        location ~ ^/(extagram\.php|index\.php)$ {
            include fastcgi_params;
            fastcgi_pass php_app;
            fastcgi_param SCRIPT_FILENAME /var/www/extagram$fastcgi_script_name;
        }
    
        # REGLA 2: Subida de Archivos (Enrutado exclusivo a S4)
        location = /upload.php {
            include fastcgi_params;
            fastcgi_pass s1-s4-upload-1:9000;
            fastcgi_param SCRIPT_FILENAME /var/www/extagram/upload.php;
            
            # Seguridad: Limitar el tamaño de subida para evitar ataques DoS
            client_max_body_size 50M;
        }
    
        # REGLA 3: Almacenamiento (Proxy hacia S5)
        location /storage/ {
            proxy_pass http://s1-s1-s5-storage-1-1:80/;
            proxy_set_header Host $host;
        }
    
        # REGLA 4: Assets Estáticos (Proxy hacia S6)
        location /static/ {
            proxy_pass http://s1-s1-s6-static-1-1:80/;
            proxy_set_header Host $host;
        }
    
        # REGLA 5: Manejo de URLs por defecto
        location / {
            index extagram.php;
            # Si la URL no existe físicamente, intenta cargar el feed principal
            try_files $uri $uri/ /extagram.php;
        }
    }
    ```
